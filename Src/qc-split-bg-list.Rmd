---
title: "Quality check 03, List blocks in block groups split by community districts"
author: "Satya Golla and Steve Simon"
date: "Created 2023-03-30"
output: html_document
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding,
  output_dir = "../results", output_format = "all") })  
---

This program lists blocks within block groups that only partially intersect with community districts.

### Load relevant files

```{r setup}
# Important abbreviations:
#    bg = block group
#    bl = block
#    cd = community district
#    co = county
#    nbd=neighborhood
#    tr = tract

library(glue)
library(magrittr)
library(sf)
library(tidyverse)
library(dplyr)
path_name <- "../data/"
terse <- FALSE
```

```{r}
conditional_glimpse <- function(x) {
  if (terse) return(invisible())
  cat("\n\n")
  cat(deparse(substitute(x)))
  cat("\n\n")
  glimpse(x)
  cat("\n\n")
  return(invisible())
}

test1 <- data.frame(x=1:3, y=4:6)
conditional_glimpse(test1)
```

### Test acs download

```{r}
library(tidycensus)
county_list <- c(
  "Johnson",
  "Leavenworth",
  "Wyandotte",
  "Cass",
  "Clay",
  "Jackson",
  "Platte")
state_list <- rep(c("KS", "MO"), c(3,4))

vlist <- c("B01001_003", "B01001_027")
load_variables(2020, "acs5", cache = TRUE) %>%
  filter(name %in% vlist)

acs_children <- NULL
for (i in 1:7) {
  acs1 <- get_acs(
    geography = "cbg", 
    variables = vlist, 
    state=state_list[i],
    county=county_list[i],
    year = 2020)
  acs_children <- rbind(acs_children, acs1)
}
glimpse(acs_children)
acs_children %<>% 
  group_by(GEOID) %>% 
  summarize(estimate=sum(estimate)) %>%
  rename(bg_id=GEOID)
glimpse(acs_children)
```

### Contents of bg

```{r}
load(glue("{path_name}bg.RData"))
conditional_glimpse(bg)
```

### Contents of bl

```{r}
load(glue("{path_name}bl.RData"))
conditional_glimpse(bl)
```

### Contents of cd

```{r}
load(glue("{path_name}cd.RData"))
conditional_glimpse(cd)
```

### Contents of co

```{r}
load(glue("{path_name}co.RData"))
conditional_glimpse(co)
```

### Contents of cd-intersections

```{r}
load(glue("{path_name}cd-intersections.RData"))
conditional_glimpse(bg_cd_intersection)
conditional_glimpse(bl_cd_intersection)
```

### Contents of cd-weights

```{r}
load(glue("{path_name}cd-weights.RData"))
conditional_glimpse(bg_counts)
conditional_glimpse(bg_list)
conditional_glimpse(bl_counts)
conditional_glimpse(bl_list)
```

### Contents of red

```{r}
load(glue("{path_name}red.RData"))
conditional_glimpse(red)
```

### Subset co to seven counties

```{r}
clist <- c(
  "20091",
  "20103",
  "20209",
  "29037",
  "29047",
  "29095",
  "29165")
co                                     %>%
  filter(GEOID %in% clist)             -> co
conditional_glimpse(co)
```

### Get id values for all community districts

```{r}
cd                                     %>%
  tibble                               %>%
  distinct(cd_id)                      %>%
  arrange(cd_id)                       %>%
  pull(cd_id)                           -> cd_list
```

### High level view

```{r pull-interesting-cd-ids, echo=FALSE}
name_list <- c(
  "Brookside",
  "Midtown",
  "Swope Park",
  "Waldo",
  "Ward Parkway",
  "Greater Downtown",
  "Antioch",
  "Little Blue Valley",
  "Rosedale",
  "Argentine")

cd                                     %>%
  filter(cd_name %in% name_list)       %>%
  pull(cd_id)                           -> interesting_cd
```

```{r pull-information, echo=FALSE}
pick_bg <- function(da, i_bg) {
  # Use this with
  #    bg
  #    bl
  da                                  %>%
    filter(bg_id %in% i_bg)           %>%
    return
}

pick_bg_cd <- function(da, i_bg, i_cd) {
  # Use this with
  #   bg_cd_intersection
  #   bg_counts
  #   bl_counts
  #   red
  da                                  %>%
    filter(bg_id %in% i_bg)           %>%
    filter(cd_id %in% i_cd)           %>%
    return
}

pick_bl <- function(da, i_bg) {
  # Use this with
  #    bl
  da                                  %>%
    filter(bg_id %in% i_bg)           %>%
    return
}

pick_bl_cd <- function(da, i_bl, i_cd) {
  # Use this with
  #   bl_cd_intersection
  #   bl_counts
  #   red
  da                                  %>%
    filter(bl_id %in% i_bl)           %>%
    filter(cd_id %in% i_cd)           %>%
    return
}

pick_cd <- function(da, i_cd) {
  # Use this with
  #    cd
  da                                  %>%
    filter(cd_id %in% i_cd)           %>%
    return
}

```

```{r plot-pieces, echo=FALSE}
merge_info <- function(i_bg) {
  bl %>% pick_bg(i_bg)                -> bl0

  bl_counts                          %>%
    pick_bg_cd(i_bg, i_cd)           %>%
    mutate(
      prop_in = round(100*prop_in))  %>%
    data.frame                        -> view_bl_counts

  bg_cd_intersection                 %>%
    pick_bg_cd(i_bg, i_cd)           %>%
    mutate(
      bg_prop_in = 
        round(100*bg_prop_in))       %>%
    data.frame                        -> view_bl_cd

  red                                %>%
    pick_bg(i_bg)                    %>%
    data.frame                        -> view_red

  view_red                           %>%
    select(-bg_id)                   %>%
    full_join(
      view_bl_counts, 
      by="bl_id")                    %>%
    select(
      bl_id,
      prop_in,
      people,
      units,
      people_in,
      units_in)                      %>%
    arrange(
      desc(prop_in), 
      desc(people))                  %>%
    data.frame                        -> view_merge
  view_merge[is.na(view_merge)] <- 0
  return(view_merge)
}
```

```{r, echo=FALSE}
calc_sf_text <- function(sf0, sf_id) {
  sf0                           %>%
    st_point_on_surface               %>%
    # st_coordinates                    %>%
    bind_cols(sf0[ , sf_id])     -> sf_coords
  if (terse) return(sf_coords)
  cat("sf_coords")
  conditional_glimpse(sf_coords)
  return(sf_coords)
}

plot_green <- function(sf1, sf2, sf_text) {
  # draw sf1 in green
  ggplot(sf1)                           +
    xlab("Longitude")                   +
    ylab("Latitude")                    +
      geom_sf(
        aes(),
        fill="lightgreen",
        color=NA)                       -> m1
  if (is.null(sf2)) return(m1)
  
  # draw sf2 with red border
  m1                                    +
    geom_sf(
      data=sf2,
      aes(),
      fill=NA,
      color="darkred")                  -> m2

  # add text from sf_text
  m2                                    +
    geom_sf_text(
      data=sf2,
      aes(label=.data[[sf_text]]))       -> m3
  return(m3)
}
check_bl <- function(view_merge) {
  cat("Blocks inside cd\n\n")
  view_merge                         %>%
    filter(prop_in > 10)             %>%
    print

  cat("\nBlocks outside cd\n\n")
  view_merge                         %>%
    filter(
      is.na(prop_in) | 
      prop_in <= 10)                 %>%
    print

  cat("\nTotals\n\n")
  view_merge                         %>%
    summarize(
      people_in=sum(people_in, na.rm=TRUE),
      units_in=sum(units_in, na.rm=TRUE),
      people=sum(people, na.rm=TRUE),
      units=sum(units, na.rm=TRUE))  %>%
    print
}
```

```{r loop, errors=TRUE, echo=FALSE}
for (i_cd in interesting_cd[4]) {
  # add extra information to bl and bg
  bl$bg_id <- str_sub(bl$bl_id, 1, 12)
  bg$ab <- str_sub(bg$bg_id, 6, 12)
  bl$ab <- str_sub(bl$bl_id, 13, 15)
  
  # Pick subsets
  cd %>% pick_cd(i_cd) -> cd0
  bg_cd_intersection                  %>%
    pick_cd(i_cd)                     %>%
    filter(bg_prop_in > 0.1)          %>%
    select(bg_id, bg_prop_in)          -> bg_list
  bg                                  %>%
    filter(bg_id %in% bg_list$bg_id)   -> bg0

  # plot overview
  plot_green(cd0, co, "NAME")      +
    ggtitle(cd0$cd_name)           -> o_map
  plot(o_map)

  # plot intersecting block groups
  plot_green(cd0, bg0, "ab") +
    ggtitle(cd0$cd_name)           -> g_map
  plot(g_map)

  # remove interior block groups
  bg_cd_intersection                  %>%
    pick_cd(i_cd)                     %>%
    filter(bg_prop_in > 0.1)          %>%
    filter(bg_prop_in < 0.9)          %>%
    select(bg_id, bg_prop_in)          -> bg_list
  if (nrow(bg_list)==0) next

  for (i_bg in bg_list$bg_id) {
    merged_data <- merge_info(i_bg)
 
    # Create subset of bl
    bl0 <- filter(bl, bg_id==i_bg)
    bl0                                %>%
      inner_join(
        merged_data,
        by="bl_id")                     -> bl0
    
    # Calculate intersections of individual blocks
    in0 <- st_intersection(cd0, bl0)
    
    # plot blocks with abbreviated ids
    ti <- glue("Block ids for {i_bg}")
    plot_green(in0, bl0, "ab")         +
      ggtitle(ti)                      -> j_map
    plot(j_map)
 
    # plot blocks with percentage area inside
    ti <- glue("Percentage areas inside for {i_bg}")
    plot_green(in0, bl0, "prop_in")    +
      ggtitle(ti)                      -> r_map
    plot(r_map)
 
    bg_cd_counts <- pick_bg_cd(bg_counts, i_bg, i_cd)
    # label with people
    ti <- glue(
      "{i_bg} has {bg_cd_counts$people_in}",
      " people inside\n{cd0$cd_name} and",
      " {bg_cd_counts$people} people total")
    plot_green(in0, bl0, "people")      +
      ggtitle(ti)                       -> p_map 
    plot(p_map)

    # label with units
    ti <- glue(
      "{i_bg} has {bg_cd_counts$units_in}",
      " units inside\n{cd0$cd_name} and",
      " {bg_cd_counts$units} units total")
    plot_green(in0, bl0, "units")      +
      ggtitle(ti)                       -> u_map 
    plot(u_map)
    
    check_bl(merged_data)
    cat("\nCross check\n\n")
    bg_cd_counts                      %>%
      data.frame                      %>%
      select(3:6)                     %>%
      print
<<<<<<< HEAD
    }
}
```


### Test acs download

```{r}
library(tidycensus)
county_list <- c(
  "Johnson",
  "Leavenworth",
  "Wyandotte",
  "Cass",
  "Clay",
  "Jackson",
  "Platte")
state_list <- rep(c("KS", "MO"), c(3,4))

vlist <- c("B01001_003", "B01001_027")
load_variables(2020, "acs5", cache = TRUE) %>%
  filter(name %in% vlist)

acs_children <- NULL
for (i in 1:7) {
  acs1 <- get_acs(
    geography = "cbg", 
    variables = vlist, 
    state=state_list[i],
    county=county_list[i],
    year = 2020)
  acs_children <- rbind(acs_children, acs1)
  }
  ### Add information to bg0
  bg_counts                           %>%
    filter(cd_id==i_cd)               %>%
    mutate(
      w_p=round(people_in/people, 2)) %>%
    mutate(
      w_u=round(units_in/units, 2))   %>%
    inner_join(
      acs_children, by="bg_id")       %>%
    mutate(
      weighted_estimate=
        w_p*estimate)                 %>%
    select(
      bg_id,
      cd_id,
      people_in,
      people,
      w_p,
      estimate)                       
    data.frame                         -> bg3
  cat("\n\nACS children\n\n")
  print(bg3)
  cat("\nTotals\n\n")
  bg3 %>%
    summarize(
      weighted_sum=sum(weights))       %>% print
  next
  bg3                                 %>%
    inner_join(bg0, by="bg_id")        -> bg2
  conditional_glimpse(bg2)
  
  # plot w_p
  plot_green(cd0, bg0, "bg_id") %>% plot
  sf1 <- cd0
  ggplot(sf1)                           +
    xlab("Longitude")                   +
    ylab("Latitude")                    +
      geom_sf(
        aes(),
        fill="lightgreen",
        color=NA)                       -> m1
  plot(m1)
  next
  ggplot(cd0) + 
    geom_sf(
      aes(),
      fill=NA,
      color="darkred") %>% plot
  next
  ggplot(data=bg2) + geom_sf(aes()) %>% plot
  plot_green(cd0, bg2, "w_p") +
    ggtitle(cd0$cd_name)           -> g_map
  plot(g_map)
}
```
