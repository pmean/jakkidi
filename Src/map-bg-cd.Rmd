---
title: "Map block groups and community districts"
author: "Steve Simon"
date: "Created 2023-04-06"
output: html_document
---

### Program purpose

This program will map a community district in green, add census blocks with red border, and place text inside the border.

### Load key functions

Running annotate-maps.R will create some useful functions.

+ conditional_glimpse
+ plot_green
+ find_bg
+ find_bl
+ align_tx
+ download_acs

```{r setup}
library(tidyverse)
run_tests <- TRUE # allow simple function tests
terse <- FALSE # display information on intermediate steps
source("annotate-maps.R") # load several functions
```

### Select interesting cds

```{r select-cds}
name_list <- c(
  "Brookside",
  "Midtown",
  "Swope Park",
  "Waldo",
  "Ward Parkway",
  "Greater Downtown",
  "Antioch",
  "Little Blue Valley",
  "Rosedale",
  "Argentine")

cd                                     %>%
  filter(cd_name %in% name_list)       %>%
  pull(cd_id)                           -> interesting_cd
```

### Check out bg_prop_in

```{r map-bg_prop_in}
for(i_cd in sort(cd$cd_id)[1]) {
  # create subsets
  cd0 <- filter(cd, cd_id==i_cd)
  bg0 <- find_bg(i_cd)
  bg0$bg_area <- round(bg0$bg_area/(10^6), 2)
  bg_text <- align_tx(bg0, bg_counts, i_cd)
  bg0$short_id <- str_sub(bg0$bg_id, 6, 12)

  # loop for text variables found in bg_text
  for (v in c("bg_prop_in")) {
    ti <- glue("{v} for {cd0$cd_name} ({cd0$cd_id})")
    plot_green(cd0, bg0, bg_text[[v]]) +
      ggtitle(ti)                        -> bg_plot
    plot(bg_plot)
  }
}
```

### Get counts of people and units

Look only at interesting community districts and focus only on those block groups that have more than 5% of their area inside the community district.

```{r map-people}
for(i_cd in sort(interesting_cd)[1]) {
  # create subsets
  cd0 <- filter(cd, cd_id==i_cd)
  bg0 <- find_bg(i_cd, lo=0.05)
  bg0$bg_area <- round(bg0$bg_area/(10^6), 2)
  bg_text <- align_tx(bg0, bg_counts, i_cd)
  bg0$short_id <- str_sub(bg0$bg_id, 6, 12)

  # loop for text variables found in bg_text
  for (v in c(
      "short_id", 
      "people", 
      "units")) {
    ti <- glue("{v} for {cd0$cd_name} ({cd0$cd_id})")
    plot_green(cd0, bg0, bg_text[[v]]) +
      ggtitle(ti)                        -> bg_plot
    plot(bg_plot)
  }
}
```

### Get counts of children 5 and under

```{r map-children, error=TRUE}
for(i_cd in interesting_cd) {
  # create subsets
  cd0 <- filter(cd, cd_id==i_cd)
  bg0 <- find_bg(i_cd, lo=0.05)
  vlist <- c("B01001_003", "B01001_027")
  acs_kids <- download_acs(vlist)
  acs_kids                            %>%
    group_by(GEOID)                   %>%
    summarize(acs_kids=sum(estimate)) %>%
    rename(bg_id=GEOID)                -> acs_kids
  conditional_glimpse(acs_kids)
  bg_text <- align_tx(acs_kids, bg0)
  conditional_glimpse(bg_text)

  # loop for text variables found in acs_text
  for (v in c("acs_kids")) {
    ti <- glue("{v} for {cd0$cd_name} ({cd0$cd_id})")
    plot_green(cd0, bg0, bg_text[[v]]) +
      ggtitle(ti)                        -> bg_plot
    plot(bg_plot)
  }
}
```

```

